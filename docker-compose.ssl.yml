version: "3.8"

services:
  # Main FANO STT Application
  fano-stt-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fano-stt-app
    environment:
      - NODE_ENV=production
      - PORT=3001
    expose:
      - "3001"
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - fano-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3001/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # FANO STT Proxy Service
  fano-proxy:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    container_name: fano-proxy
    environment:
      - NODE_ENV=production
      - PORT=8080
      - AUTH_TOKEN=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJmYW5vX2RlbmllZF9hY2Nlc3MiOlsiY2FsbGludGVyOndvcmtzcGFjZS0qIiwiY2FsbGludGVyOnZvaWNlcHJpbnQtKiIsImNhbGxpbnRlcjp3b3JkLWNsb3VkLSoiLCJjYWxsaW50ZXI6cHJvLXNlYXJjaC1hbmQtc2F2ZS1xdWVyeSIsImNhbGxpbnRlcjp3b3Jrc3BhY2Utbm90aWZpY2F0aW9uLXRhcmdldCIsImNhbGxpbnRlcjpub3RpZmljYXRpb24tdGFyZ2V0IiwiSW50ZW50OioiLCJQb3J0YWw6c3VwZXItdXNlciJdLCJmYW5vX3NwZWVjaF9kaWFyaXplX3F1b3RhX3N0cmF0ZWd5IjoiZGVmYXVsdCIsImZhbm9fc3BlZWNoX2dlbmVyYXRlX3ZvaWNlcHJpbnRfcXVvdGFfc3RyYXRlZ3kiOiJkZWZhdWx0IiwiZmFub19zcGVlY2hfcmVjb2duaXplX3F1b3RhX3N0cmF0ZWd5IjoiZGVmYXVsdCIsImZhbm9fc3BlZWNoX3N0cmVhbWluZ19kZXRlY3RfYWN0aXZpdHlfcXVvdGFfc3RyYXRlZ3kiOiJkZWZhdWx0IiwiZmFub19zcGVlY2hfc3RyZWFtaW5nX3JlY29nbml6ZV9xdW90YV9zdHJhdGVneSI6ImRlZmF1bHQiLCJmYW5vX3NwZWVjaF9yZXBsYWNlX3BocmFzZXNfcXVvdGFfc3RyYXRlZ3kiOiJkZWZhdWx0IiwiZmFub19zcGVlY2hfc3ludGhlc2l6ZV9zcGVlY2hfcXVvdGFfc3RyYXRlZ3kiOiJkZWZhdWx0IiwiaWF0IjoxNzYyNzM4ODg3LCJleHAiOjE3NjUzODI0MDAsImF1ZCI6InRlbXAtb2NiYy1ydHN0dC1wb2MiLCJzdWIiOiJPQ0JDIiwiaXNzIjoiaHR0cHM6Ly9hdXRoLmZhbm8uYWkifQ.Gj3qIyhD2aZvNADKSlOPKnI4w8dMgEDcgiybx8vGn5xTSdYeBw_d9AiyoCjOQb0m-FAJRRL73ykXYLV_Q5EjzvCt4Kmigdb40N5aFCssQ2rq0yUry2rxhT84eBNptfwOy6SJPoZOTkrTm026W8DkFOzNO_NxFWJLmjMZiRfJAGhOBmfEZlDJxmfTaVNKWC-qD2b-p09JoXsRU7hOcvHrmST7igbEwiHunA9ig1T9dfFoxPulMCsIDl7VsCK_AbbjWWpAJ2mkqjyDyzMLlTxBKbVIKX_s8V9dG9VgiHzCGTBiV4uuoiAsoupJ7GOdov6xmvdG2UMVuUv1yh3D78JTSA
    expose:
      - "8080"
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - fano-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "const http = require('http'); http.get('http://localhost:8080', (res) => { process.exit(res.statusCode === 404 ? 0 : 1); }).on('error', () => process.exit(1));",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx SSL Reverse Proxy
  nginx:
    image: nginx:1.25-alpine
    container_name: fano-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/letsencrypt:ro
      - ./certbot-data:/var/www/certbot:ro
      - ./nginx-logs:/var/log/nginx
    depends_on:
      - fano-stt-app
      - fano-proxy
    restart: unless-stopped
    networks:
      - fano-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:80/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Certbot for SSL certificate management
  # Note: Let's Encrypt doesn't support IP addresses directly
  # For IP-based SSL, you have several options:
  # 1. Use a domain name with nip.io (e.g., 143.198.192.233.nip.io)
  # 2. Use self-signed certificates
  # 3. Get a proper domain name
  certbot:
    image: certbot/certbot:latest
    container_name: fano-certbot
    volumes:
      - ./ssl:/etc/letsencrypt
      - ./certbot-data:/var/www/certbot
    # Option 1: Use nip.io for IP-based domain
    command: certonly --webroot --webroot-path=/var/www/certbot --email admin@example.com --agree-tos --no-eff-email -d 143.198.192.233.nip.io
    # Option 2: Use actual domain (replace with your domain)
    # command: certonly --webroot --webroot-path=/var/www/certbot --email admin@yourdomain.com --agree-tos --no-eff-email -d yourdomain.com
    depends_on:
      - nginx
    networks:
      - fano-network
    profiles:
      - ssl-setup

  # SSL Certificate Renewal (runs daily)
  certbot-renew:
    image: certbot/certbot:latest
    container_name: fano-certbot-renew
    volumes:
      - ./ssl:/etc/letsencrypt
      - ./certbot-data:/var/www/certbot
    command: renew --webroot --webroot-path=/var/www/certbot --quiet
    depends_on:
      - nginx
    networks:
      - fano-network
    profiles:
      - ssl-renew

networks:
  fano-network:
    driver: bridge

volumes:
  ssl-certs:
    driver: local
  nginx-logs:
    driver: local
  certbot-data:
    driver: local
