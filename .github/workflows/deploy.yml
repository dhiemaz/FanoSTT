name: Deploy to Digital Ocean

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}

      - name: Add Digital Ocean host to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Digital Ocean
        env:
          DO_HOST: ${{ secrets.DO_HOST }}
          DO_USER: ${{ secrets.DO_USER }}
          AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
        run: |
          # Create environment file first
          ssh $DO_USER@$DO_HOST "echo 'AUTH_TOKEN=$AUTH_TOKEN' > /opt/fano-stt/.env"
          ssh $DO_USER@$DO_HOST "echo 'WEBSOCKET_URL=ws://10.104.0.2:8080' >> /opt/fano-stt/.env"
          ssh $DO_USER@$DO_HOST "echo 'NEXT_PUBLIC_WEBSOCKET_URL=ws://143.198.192.233:8080' >> /opt/fano-stt/.env"
          ssh $DO_USER@$DO_HOST "echo 'WEB_PORT=3001' >> /opt/fano-stt/.env"
          ssh $DO_USER@$DO_HOST "echo 'PROXY_PORT=8080' >> /opt/fano-stt/.env"
          ssh $DO_USER@$DO_HOST "echo 'NODE_ENV=production' >> /opt/fano-stt/.env"
          ssh $DO_USER@$DO_HOST "echo 'NEXT_TELEMETRY_DISABLED=1' >> /opt/fano-stt/.env"
          ssh $DO_USER@$DO_HOST "echo 'PORT=3001' >> /opt/fano-stt/.env"
          ssh $DO_USER@$DO_HOST "echo 'HOSTNAME=0.0.0.0' >> /opt/fano-stt/.env"

          # Deploy application
          ssh $DO_USER@$DO_HOST << 'EOF'
            # Navigate to app directory
            cd /opt/fano-stt || exit 1

            # Pull latest changes
            git pull origin main

            # Stop existing services
            docker-compose -f docker-compose.yml down || true

            # Remove old images to free space
            docker system prune -f

            # Build and start services
            docker-compose -f docker-compose.yml up --build -d

            # Show status
            docker-compose -f docker-compose.yml ps

            # Check logs for any immediate issues
            docker-compose -f docker-compose.yml logs --tail=20

            echo "Deployment completed successfully!"
          EOF

      - name: Verify deployment
        env:
          DO_HOST: ${{ secrets.DO_HOST }}
          DO_USER: ${{ secrets.DO_USER }}
        run: |
          ssh $DO_USER@$DO_HOST << 'EOF'
            # Wait a moment for services to start
            sleep 10

            # Check if services are running
            if docker-compose -f /opt/fano-stt/docker-compose.yml ps | grep -q "Up"; then
              echo "‚úÖ Services are running"

              # Test health endpoint if available
              if curl -f http://localhost:3001/api/health >/dev/null 2>&1; then
                echo "‚úÖ Health check passed"
              else
                echo "‚ö†Ô∏è Health check failed, but containers are running"
              fi
            else
              echo "‚ùå Services are not running"
              docker-compose -f /opt/fano-stt/docker-compose.yml logs
              exit 1
            fi
          EOF

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "üéâ Deployment to Digital Ocean completed successfully!"
          else
            echo "‚ùå Deployment failed. Check the logs above."
          fi
